stages:
  - prebuild
  - build
  # Tests? Where we're going, we don't need tests.
  - deploy

build-windows:
  image: cafstep/helveg-ci:windows
  stage: prebuild
  script:
    - '& c:/BuildTools/Common7/Tools/Launch-VsDevShell.ps1'
    - '& ./build.ps1'
  cache:
    paths:
      - build/_deps
  artifacts:
    paths:
      - artifacts/
  tags:
    - office-windows
  only:
    - ci

build-linux:
  dependencies:
    - build-windows
  image: cafstep/helveg-ci
  stage: build
  script:
    - ./build.sh --install --pack
  cache:
    paths:
      - build/_deps
  artifacts:
    paths:
      - artifacts/
  only:
    - ci

build-linux:
  dependencies:
    - build-windows
    - build-linux
  image: mcr.microsoft.com/dotnet/core/sdk:3.1
  stage: deploy
  script:
    - dotnet nuget push ./artifacts/helveg*.nupkg --source nuget.org --api-key $NUGET_API_KEY
  only:
    - ci
